const http = require('http')
const fetch = require('node-fetch')

module.exports = mailman

async function mailman (pid, wire) {
  const register = wire('customer')
  const { signals: { to, from }, link } = register('mailman')

  var counter = 1
  const [name, port] = pid.split(':')
  const httpServer = http.createServer(handleDelivery)
  // httpServer.timeout = 10 * 1000
  httpServer.listen(port, () => {
    console.log(`[${name}] running on port ${port}`)
  })
  const forward = to('customer')
  from('customer')(function handleSending (message) {
    message.id = counter++
    message.from = pid
    message.refs = message.refs || []
    const [name, port] = mesage.to.split(':')
    const url = `http://localhost:${port}`
    fetch(url, { method: 'POST', body: JSON.stringify(message) })
    return message.id
  })
  function handleDelivery (req, res) {
    var message = ''
    req.on('data', chunk => { message += chunk })
    req.on('end', async () => {
      try {
        await forward(message)
        res.statusCode = 200
        res.statusMessage = 'ok'
        res.end()
      } catch (error) {
        res.statusCode = 500
        res.statusMessage = 'error'
        res.end(error)
      }
    })
  }
}
