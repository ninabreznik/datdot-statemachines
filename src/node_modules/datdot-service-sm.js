const XState = require('xstate')
const { Machine, assign, spawn, send, sendParent, actions } = XState
const { choose } = actions

const user = require('user-sm')
const plan = require('plan-sm')
const encode = require('encode-sm')
const host = require('host-sm')
const attest_setup = require('attest-setup-sm')
const attest_storage = require('attest-storage-sm')
const attest_performance = require('attest-performance-sm')
const attest_lead_performance = require('attest-lead-performance-sm')


const user_actor = assign({ actors: (context, event) => {
  const name = event.name
  return [ ...context.actors, { name, ref: spawn(user, name, { sync: true }) } ]
} })

const plan_actor = assign({ actors: (context, event) => {
  const name = event.name
  return [ ...context.actors, { name, ref: spawn(plan, name, { sync: true }) } ]
} })

const hosting_setup_actor = assign({ actors: (context, event) => {
  const name = event.name
  var machine
  if (name.includes('attest')) machine = attest_setup
  else if (name.includes('host')) machine = host
  else if (name.includes('encode')) machine = encode
  return [ ...context.actors, { name, ref: spawn(machine, name, { sync: true }) } ]
} })

const storage_proof_actor = choose([
  { cond: (context, event) => event.name.includes('attest'),
    actions: assign({ actors: (context, event) => {
      const name = event.name
      return [ ...context.actors, { name, ref: spawn(attest_storage, name, { sync: true }) } ]
      }
    })
  },
  { cond: (context, event) => event.name.includes('host'),
    actions: send('STORAGE_PROOF', { to: (context, event) => event.name })
  }
])

const lead_performance_actor = assign({ actors: (context, event) => {
  const name = event.name
  return [ ...context.actors, { name, ref: spawn(attest_lead_performance, name, { sync: true }) } ]
} })

const performance_check_actor = choose([
  { cond: (context, event) => event.name.includes('attest'),
    actions: assign({ actors: (context, event) => {
      const name = event.name
      return [ ...context.actors, { name, ref: spawn(attest_performance, name, { sync: true }) } ]
      }
    })
  },
  { cond: (context, event) => event.name.includes('host'),
    actions: send('PERFORMANCE_CHECK', { to: (context, event) => event.name })
  }
])


module.exports = Machine({
  id: 'datdot-service',
  initial: 'idle',
  context: {
    actors: []
  },
  states: {
    idle: {
      on: {

        _CREATE_ACCOUNT: { actions: user_actor },

        _HOSTING_PLAN_SUBSCRIPTION: { actions: plan_actor },
        chain_PLAN_UPDATE: { actions: send('PLAN_UPDATE', { to: (context, event) => event.name }) },
        chain_PLAN_PAUSE: { actions: send('PLAN_PAUSE', { to: (context, event) => event.name }) },
        chain_PLAN_RESUME: { actions: send('PLAN_RESUME', { to: (context, event) => event.name }) },
        chain_PLAN_END: { actions: send('PLAN_END', { to: (context, event) => event.name }) },

        chain_HOSTING_SETUP: { actions: hosting_setup_actor },

        chain_STORAGE_PROOF: { actions: storage_proof_actor },

        chain_PERFORMANCE_CHECK: { actions: performance_check_actor },
        _SWARM_CHECK: { actions: send('SWARM_CHECK', { to: (context, event) => event.name }) },
        _REPORT_REVIEW: { actions: send('REPORT_REVIEW', { to: (context, event) => event.name }) },

        chain_LEAD_PERFORMANCE_CHECK: { actions: lead_performance_actor },
        _HOSTER_REPORT: { actions: send('HOSTER_REPORT', { to: (context, event) => event.name }) },
        _ORGANIZE_PERFORMANCE_CHECK: { actions: send('ORGANIZE_PERFORMANCE_CHECK', { to: (context, event) => event.name }) },
        _SEND_REPORT: { actions: send('SEND_REPORT', { to: (context, event) => event.name }) },

      },
    },
  }
  })
